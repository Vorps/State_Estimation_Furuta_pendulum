function [A, B] = PendulumLinearModelTrajectory(pp, theta_1,theta_2,theta_dot_1,theta_dot_2)
    u1 = pp.b2*pp.p3*cos(theta_2)*theta_dot_2-...
        pp.p2^2*sin(2*theta_2)*theta_dot_1*theta_dot_2+...
        pp.p2*pp.p3*(-sin(theta_2)+sin(theta_2)^3)*theta_dot_1^2+...
        pp.p2*pp.p3*sin(theta_2)*theta_dot_2^2+...
        1/2*pp.p3*pp.p4*sin(2*theta_2);
    
    u1_dot = -pp.b2*pp.p3*sin(theta_2)*theta_dot_2-...
        2*pp.p2^2*cos(2*theta_2)*theta_dot_1*theta_dot_2+...
        pp.p2*pp.p3*(-cos(theta_2)+3*sin(theta_2)^2*cos(theta_2))*theta_dot_1^2+...
        pp.p2*pp.p3*cos(theta_2)*theta_dot_2^2+...
        pp.p3*pp.p4*cos(2*theta_2);
    
    u2 = pp.cr*pp.p3*cos(theta_2)*theta_1+...
        (pp.b1*pp.p3+pp.p3*pp.p6)*cos(theta_2)*theta_dot_1-...
        pp.b2*(pp.p1+pp.p2*sin(theta_2)^2)*theta_dot_2+...
        2*pp.p2*pp.p3*(sin(theta_2)-sin(theta_2)^3)*theta_dot_1*theta_dot_2+...
        pp.p2*(pp.p2*cos(theta_2)*sin(theta_2)^3+1/2*pp.p1*sin(2*theta_2))*theta_dot_1^2-...
        1/2*pp.p3^2*sin(2*theta_2)*theta_dot_2^2-...
        pp.p4*(pp.p1*sin(theta_2)+pp.p2*sin(theta_2)^3);
    
    u2_dot = -pp.cr*pp.p3*sin(theta_2)*theta_1+...
        -(pp.b1*pp.p3+pp.p3*pp.p6)*sin(theta_2)*theta_dot_1-...
        2*pp.b2*pp.p2*cos(theta_2)*theta_dot_2+...
        2*pp.p2*pp.p3*(cos(theta_2)-3*sin(theta_2)^2*cos(theta_2))*theta_dot_1*theta_dot_2+...
        pp.p2*(pp.p2*(-sin(theta_2)^4+3*cos(theta_2)^2*sin(theta_2)^2)+pp.p1*cos(2*theta_2))*theta_dot_1^2-...
        pp.p3^2*cos(2*theta_2)*theta_dot_2^2-...
        pp.p4*(pp.p1*cos(theta_2)+3*pp.p2*sin(theta_2)^2*cos(theta_2));
    
    v = (pp.p2^2+pp.p3^2)*sin(theta_2)^2+pp.p1*pp.p2-pp.p3^2;
    v_dot = 2*(pp.p2^2+pp.p3^2)*sin(theta_2)*cos(theta_2);
    a3 = 1/v*[-pp.cr*pp.p2,...
                                  (u1_dot*v-u1*v_dot)/v ,...
                                  -pp.p2*pp.p6-pp.b1*pp.p2-pp.p2^2*sin(2*theta_2)*theta_dot_2-2*pp.p2*pp.p3*sin(theta_2)*(1-sin(theta_2)^2)*theta_dot_1,...
                                  pp.b2*pp.p3*cos(theta_2)-pp.p2^2*sin(2*theta_2)*theta_dot_1+2*pp.p2*pp.p3*sin(theta_2)*theta_dot_2];
                              
    a4 = 1/v*[pp.cr*pp.p3*cos(theta_2),...
                                    (u2_dot*v-u2*v_dot)/v,...
                                   (pp.b1*pp.p3+pp.p3*pp.p6)*cos(theta_2)+2*pp.p2*pp.p3*sin(theta_2)*(1-sin(theta_2)^2)*theta_dot_2+2*pp.p2*(pp.p2*cos(theta_2)*sin(theta_2)^3+1/2*pp.p1*sin(2*theta_2))*theta_dot_1,...
                                  -pp.b2*(pp.p1+pp.p2*sin(theta_2)^2)+2*pp.p2*pp.p3*sin(theta_2)*(1-sin(theta_2)^2)*theta_dot_1-pp.p3^2*sin(2*theta_2)*theta_dot_2];
    b3 = pp.p2*pp.p5/v;
    b4 = -pp.p3*pp.p5*cos(theta_2)/v;
                              
    A = [0,0,1,0;0,0,0,1;a3;a4];
    B = [0;0;b3; b4];
end